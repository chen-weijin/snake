# 腾讯云部署排行榜服务器

## 一、部署前准备

### 1. 腾讯云账号
- 注册并登录腾讯云控制台：https://console.cloud.tencent.com/

### 2. 域名准备（可选）
- 如有需要，提前注册域名并完成备案

## 二、创建CVM实例

### 1. 选择实例配置
- **地域**：选择靠近目标用户的地域（如华南地区-广州）
- **实例类型**：建议选择2核4G及以上配置（如S5.MEDIUM4）
- **镜像**：选择Ubuntu 20.04 LTS或CentOS 7.9
- **存储**：系统盘50GB SSD云硬盘
- **网络**：选择默认VPC，分配公网IP

### 2. 设置登录方式
- 选择密钥登录，创建新密钥对并下载私钥文件
- 或设置密码登录（不推荐，安全性较低）

### 3. 配置安全组
- 开放端口：22（SSH）、3000（应用端口）、27017（MongoDB，可选，建议仅允许内网访问）

## 三、连接CVM实例

### 1. 使用SSH连接
- Windows：使用PuTTY或Windows Terminal
- macOS/Linux：使用Terminal

```bash
# 使用密钥登录
ssh -i /path/to/your-key.pem ubuntu@your-server-ip

# 使用密码登录
ssh ubuntu@your-server-ip
```

## 四、环境配置

### 1. 更新系统
```bash
# Ubuntu
sudo apt update && sudo apt upgrade -y

# CentOS
sudo yum update -y
```

### 2. 安装Node.js
```bash
# Ubuntu
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS
curl -fsSL https://rpm.nodesource.com/setup_16.x | sudo bash -
sudo yum install -y nodejs
```

### 3. 安装MongoDB
```bash
# Ubuntu
wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list
sudo apt update
sudo apt install -y mongodb-org

# CentOS
sudo tee /etc/yum.repos.d/mongodb-org-5.0.repo << EOF
[mongodb-org-5.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/7/mongodb-org/5.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-5.0.asc
EOF
sudo yum install -y mongodb-org
```

### 4. 启动MongoDB服务
```bash
# Ubuntu/CentOS
sudo systemctl start mongod
sudo systemctl enable mongod
```

## 五、部署代码

### 1. 安装Git
```bash
# Ubuntu
sudo apt install -y git

# CentOS
sudo yum install -y git
```

### 2. 克隆代码
```bash
git clone https://your-repo-url/rank-server.git
cd rank-server
```

### 3. 安装依赖
```bash
npm install
```

### 4. 配置环境变量
```bash
# 创建环境变量文件
echo "PORT=3000" > .env
echo "MONGODB_URI=mongodb://localhost:27017/rank-server" >> .env
```

### 5. 初始化排行榜配置
```bash
# 使用curl初始化配置
curl -X POST http://localhost:3000/v2/rank/api/report/initconfig \
  -H "Content-Type: application/json" \
  -d '{"appid": "SM3400376871559255"}'
```

## 六、启动服务

### 1. 使用PM2管理服务
```bash
# 安装PM2
npm install -g pm2

# 启动服务
pm2 start src/app.js --name "rank-server"

# 设置开机自启
pm2 startup
pm2 save
```

### 2. 验证服务状态
```bash
# 查看服务状态
pm2 status

# 查看日志
pm2 logs rank-server
```

## 七、配置安全组

1. 登录腾讯云控制台，进入CVM实例详情
2. 点击「安全组」-「配置规则」
3. 添加入站规则：
   - 端口：3000，协议：TCP，来源：0.0.0.0/0
   - 端口：22，协议：TCP，来源：0.0.0.0/0（或限制特定IP）
   - 端口：27017，协议：TCP，来源：127.0.0.1/32（仅允许本地访问）

## 八、域名配置（可选）

### 1. 域名解析
- 进入「云解析DNS」控制台
- 添加A记录，将域名指向CVM公网IP

### 2. 配置HTTPS（可选）
```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx  # Ubuntu
sudo yum install -y certbot python3-certbot-nginx  # CentOS

# 申请SSL证书
certbot --nginx -d your-domain.com
```

## 九、监控和维护

### 1. 腾讯云监控
- 开启「云监控」服务，监控CVM实例状态
- 设置告警规则，如CPU使用率过高、内存不足等

### 2. 数据库备份
```bash
# 定期备份MongoDB
mongodump --db rank-server --out /path/to/backup/$(date +%Y%m%d)
```

### 3. 日志管理
- 使用PM2日志或配置日志轮转

## 十、常见问题排查

1. **服务无法启动**：检查PM2日志，查看具体错误信息
2. **数据库连接失败**：检查MongoDB服务状态和连接字符串
3. **API无法访问**：检查安全组配置和防火墙规则
4. **端口被占用**：使用`netstat -tuln`查看端口占用情况

## 十一、优化建议

1. **使用腾讯云MongoDB Atlas**：替代本地MongoDB，提供更高可靠性和扩展性
2. **使用负载均衡**：当用户量增加时，可考虑使用负载均衡服务
3. **CDN加速**：对静态资源使用CDN加速
4. **弹性伸缩**：根据业务需求，配置自动伸缩组

通过以上步骤，您可以在腾讯云上成功部署和运行排行榜服务器。部署完成后，游戏客户端可以通过配置的域名或IP地址访问排行榜API。