# 实现游戏排行榜功能

## 一、当前情况分析

1. **客户端实现已完成**：
   - `RankManager.ts`：处理与服务器的通信
   - `APRankPanel.ts`：排行榜主UI面板
   - `APRankSelectBtn.ts`：排行榜类型选择
   - `APRankUIItem.ts`：单个排行榜条目UI
   - 配置了排行榜远程URL：`https://api.sm0.fun/v2/rank/api/report/`

2. **需要实现的功能**：
   - 服务器端排行榜系统
   - 数据库设计
   - API接口实现
   - 排行榜数据存储和管理

## 二、实现方案

### 1. 服务器端技术选型

- **后端框架**：Node.js + Express
- **数据库**：MongoDB（存储排行榜数据）
- **部署方式**：云服务器部署

### 2. 数据库设计

#### 2.1 排行榜配置表（rank_configs）
```
{
  _id: ObjectId,
  appid: String,       // 游戏ID
  rankid: String,      // 排行榜ID（如"rank_total"、"rank_day"）
  name: String,        // 排行榜名称
  order: String,       // 排序方式："asc"（升序）或"desc"（降序）
  min_score: Number,   // 进榜最低分数
  max_count: Number,   // 排行榜最大记录数
  created_at: Date,
  updated_at: Date
}
```

#### 2.2 排行榜数据表（rank_data）
```
{
  _id: ObjectId,
  appid: String,       // 游戏ID
  rankid: String,      // 排行榜ID
  openid: String,      // 玩家OpenID
  playername: String,  // 玩家名称
  portrait: String,    // 玩家头像URL
  score: Number,       // 玩家分数
  ext: String,         // 扩展数据（JSON格式）
  created_at: Date,
  updated_at: Date
}
```

### 3. API接口实现

#### 3.1 获取排行榜配置（GET /rankconfig）
- **请求URL**：`/rankconfig?appid={appid}`
- **请求参数**：
  - appid：游戏ID
- **响应格式**：
  ```json
  [
    {
      "rankid": "rank_total",
      "name": "总排行榜",
      "order": "desc",
      "min_score": 0
    },
    {
      "rankid": "rank_day",
      "name": "日排行榜",
      "order": "desc",
      "min_score": 0
    }
  ]
  ```

#### 3.2 上报玩家分数（POST /rankreport）
- **请求URL**：`/rankreport?appid={appid}`
- **请求参数**：
  ```json
  {
    "appid": "SM3400376871559255",
    "rankid": "rank_total",
    "openid": "玩家OpenID",
    "score": 100,
    "playername": "玩家名称",
    "portrait": "头像URL",
    "ext": "{\"level\": 5}"
  }
  ```
- **响应格式**：
  ```json
  {"code": 0, "message": "success"}
  ```

#### 3.3 获取排行榜数据（POST /rankdata）
- **请求URL**：`/rankdata?appid={appid}`
- **请求参数**：
  ```json
  {
    "appid": "SM3400376871559255",
    "rankid": "rank_total",
    "openid": "玩家OpenID",
    "range_from": 0,
    "range_to": 100,
    "ranklevel": 0
  }
  ```
- **响应格式**：
  ```json
  {
    "ranklist": [
      {
        "rank": 1,
        "openid": "玩家1OpenID",
        "playername": "玩家1",
        "portrait": "头像1URL",
        "score": 1000
      },
      // 更多排行数据
    ],
    "self": {
      "rank": 10,
      "openid": "当前玩家OpenID",
      "playername": "当前玩家",
      "portrait": "当前玩家头像URL",
      "score": 500
    }
  }
  ```

### 4. 实现步骤

1. **搭建服务器环境**：
   - 安装Node.js和MongoDB
   - 配置云服务器

2. **创建项目结构**：
   ```
   rank-server/
   ├── src/
   │   ├── app.js          # 主应用入口
   │   ├── routes/         # API路由
   │   │   └── rank.js     # 排行榜相关路由
   │   ├── models/         # 数据模型
   │   │   ├── RankConfig.js
   │   │   └── RankData.js
   │   ├── controllers/    # 控制器
   │   │   └── rankController.js
   │   └── utils/          # 工具函数
   ├── package.json
   └── config.js           # 配置文件
   ```

3. **实现数据库模型**：
   - 定义RankConfig和RankData模型
   - 配置数据库连接

4. **实现API接口**：
   - 实现rankconfig、rankreport、rankdata三个接口
   - 添加请求验证和错误处理

5. **部署服务器**：
   - 部署到云服务器
   - 配置域名和HTTPS
   - 启动服务

6. **测试功能**：
   - 使用Postman测试API接口
   - 游戏客户端测试排行榜功能

## 三、注意事项

1. **性能优化**：
   - 对排行榜数据添加索引，提高查询效率
   - 考虑使用Redis缓存热门排行榜数据

2. **安全性**：
   - 添加请求签名验证，防止恶意请求
   - 对玩家分数进行合法性检查
   - 限制API请求频率

3. **扩展性**：
   - 支持多种排行榜类型（总榜、日榜、周榜等）
   - 支持不同游戏的排行榜隔离

4. **数据备份**：
   - 定期备份数据库
   - 实现数据恢复机制

## 四、预期效果

1. 排行榜功能正常运行
2. 玩家可以查看自己的排名和其他玩家的排名
3. 分数上报和排行榜更新实时生效
4. 支持多种排行榜类型切换

通过以上方案，我们可以完整实现游戏的排行榜功能，让玩家能够查看和比较自己的游戏成绩。