## 服务器重构与功能扩展计划（含客户端同步）

### 1. 目录结构重构
- **创建新的服务器根目录**: `server/`
- **迁移排行榜功能**: 将 `rank-server/` 中的所有功能移至 `server/rank/` 目录
- **创建用户功能目录**: `server/user/` 用于处理用户相关功能，包括 `getUserData` 和 `setUserData` 接口

### 2. 数据库扩展
- **新增用户表**: `User` 表，包含以下字段：
  - `_id`: 主键
  - `openid`: 用户唯一标识
  - `code`: 微信登录凭证码
  - `appid`: 应用ID
  - `user_data`: 存储用户自定义数据（JSON格式）
  - `created_at`: 创建时间
  - `updated_at`: 更新时间
- **保留现有排行榜表**: `RankData` 和 `RankConfig`

### 3. 服务器功能实现
- **排行榜功能**: 保持现有功能不变，迁移至新目录结构
- **用户功能**:
  - **微信登录处理**: 实现 `code2openid` 接口，将微信登录凭证码转换为 openid
  - **用户数据接口**: 
    - 实现并修改 `GET /v2/userdata/getUserData` 接口，返回用户信息
    - 实现并修改 `POST /v2/userdata/setUserData` 接口，保存用户信息
    - 确保两个接口在 106.53.198.49 上可访问
  - **openid 生成**: 当用户首次登录时，基于微信 code 生成唯一 openid

### 4. API 接口设计
- **排行榜接口**: 保持现有接口路径不变
- **用户接口**:
  - `POST /v2/userdata/code2openid`: 微信 code 转换为 openid
  - `GET /v2/userdata/getUserData`: 获取用户数据（修改为在 106.53.198.49 上实现）
  - `POST /v2/userdata/setUserData`: 保存用户数据（修改为在 106.53.198.49 上实现）

### 5. 客户端同步更新
- **API 调用更新**: 修改客户端代码中的 API 调用地址，确保指向新的服务器地址 106.53.198.49
- **登录流程更新**: 更新微信登录流程，确保使用新的 `code2openid` 接口
- **用户数据管理**: 更新用户数据的获取和保存逻辑，使用新的 `getUserData` 和 `setUserData` 接口
- **错误处理**: 添加适当的错误处理，确保客户端能够优雅处理 API 调用失败的情况

### 6. 排行榜工具同步更新
- **配置文件更新**: 修改排行榜工具的配置文件，确保指向新的服务器地址
- **API 调用更新**: 更新工具中的 API 调用路径，确保与新的服务器接口匹配
- **测试验证**: 确保排行榜工具能够正常连接到新服务器并执行所有功能

### 7. 技术实现细节
- **使用现有技术栈**: Express + Mongoose + MongoDB
- **保持代码风格一致**: 遵循现有代码的命名规范和结构
- **确保向后兼容**: 保持现有排行榜 API 的功能不变
- **添加错误处理**: 完善错误处理机制，确保 API 稳定性
- **接口修改**: 确保 `getUserData` 和 `setUserData` 接口在新服务器上正常工作

### 8. 部署配置
- **更新配置文件**: 修改数据库连接和服务器配置
- **更新启动脚本**: 确保服务器能正常启动和运行
- **测试验证**: 确保所有功能正常工作，包括修改后的 `getUserData` 和 `setUserData` 接口
- **集成测试**: 确保客户端、服务器和工具之间的集成正常

### 9. 验证步骤
- **服务器功能测试**: 验证所有 API 接口正常工作
- **客户端功能测试**: 验证客户端能够正常登录、获取和保存用户数据
- **排行榜工具测试**: 验证排行榜工具能够正常连接和操作
- **端到端测试**: 验证完整的用户流程，从登录到数据保存再到排行榜更新

### 10. 文档更新
- **API 文档**: 更新 API 文档，记录新的接口路径和参数
- **部署文档**: 更新部署文档，记录新的目录结构和配置
- **使用文档**: 更新使用文档，记录客户端和工具的更新步骤